# 多图笔记问题排查

**日期**: 2026-02-05
**问题**: 单图笔记显示正常，多图笔记图片不显示

---

## 📋 当前情况

### 测试结果

| 行号 | 笔记链接 | 标题 | 图片显示情况 |
|------|---------|------|-------------|
| 66 | `http://xhslink.com/o/uBGhxHFcnn` | 豆豆浆 | ✅ 显示了图片（单图）|
| 67 | `http://xhslink.com/o/8THIW4iSlOi` | dearAaron. | ❌ 没有显示图片（多图）|

---

## 🔍 可能的原因

### 原因1: 飞书表格字段配置问题

**代码逻辑** (`app/api/feishu/append-row/route.ts:256-261`):
```typescript
// 添加图片附件字段（字段名必须与飞书表格完全一致）
if (fileTokens[0]) recordFields['封面'] = [{ file_token: fileTokens[0] }]
if (fileTokens[1]) recordFields['图片2'] = [{ file_token: fileTokens[1] }]
if (fileTokens.length > 2) {
  // 第3张及后续图片都放到"后续图片"字段
  recordFields['后续图片'] = fileTokens.slice(2).map(token => ({ file_token: token }))
}
```

**检查项**:
- [ ] 飞书表格是否有"封面"字段？
- [ ] 飞书表格是否有"图片2"字段？
- [ ] 飞书表格是否有"后续图片"字段？
- [ ] 这些字段的类型是否为"附件"类型？
- [ ] 字段名称是否完全匹配（包括大小写）？

---

### 原因2: 多图笔记的图片上传失败

**可能情况**:
1. 第2张图片下载失败
2. 第2张图片上传飞书失败
3. Token 权限不足

**验证方法**:
查看 Vercel 函数日志中的图片处理信息：
```
[飞书导出API] 开始并行处理图片...
[飞书导出API] 开始处理第 1 张图片...
[飞书导出API] 第 1 张图片处理完成
[飞书导出API] 开始处理第 2 张图片...  ← 看这里
[飞书导出API] 第 2 张图片处理完成      ← 和这里
[飞书导出API] 成功上传 2/2 张图片      ← 最终结果
```

---

### 原因3: 短链接过期导致图片数据缺失

**情况说明**:
- 第67行短链接现在返回404，无法获取图片
- 但表格中有标题"dearAaron."，说明之前成功保存过
- 可能在保存时图片字段就是空的

**验证方法**:
使用一个**确定有效的多图笔记链接**重新测试

---

## 🧪 排查步骤

### 步骤1: 检查飞书表格字段配置

1. 打开你的飞书多维表格
2. 点击表格右上角的"字段管理"
3. 检查是否存在以下字段：
   - "封面" - 附件类型
   - "图片2" - 附件类型
   - "后续图片" - 附件类型

**如果字段名称不同**:
需要修改 `app/api/feishu/append-row/route.ts:256-261` 的字段名称

---

### 步骤2: 查看 Vercel 函数日志

1. 登录 Vercel Dashboard
2. 进入项目 → Functions
3. 找到 `api/feishu/append-row` 函数
4. 查看第67行笔记的处理日志

**关键信息**:
```
[飞书导出API] 图片数量: X    ← 应该是多少张？
[飞书导出API] 开始并行处理图片...
[飞书导出API] 成功上传 X/Y 张图片  ← 成功了几张？
```

---

### 步骤3: 使用有效的多图笔记测试

找一个**新的、有效的**小红书多图笔记：

1. 打开小红书APP
2. 找一个有2-3张图片的笔记
3. 分享 → 复制链接
4. 使用快捷指令测试
5. 检查飞书表格

**预期结果**:
- 第1张图片显示在"封面"字段
- 第2张图片显示在"图片2"字段
- 第3张图片（如果有）显示在"后续图片"字段

---

### 步骤4: 本地测试（如果有有效链接）

如果你有一个有效的多图笔记链接，可以在本地测试：

```bash
# 1. 测试解析API
curl -X POST http://localhost:3000/api/xiaohongshu/parse \
  -H "Content-Type: application/json" \
  -d '{"url":"你的多图笔记链接"}' | jq '.data.images | length'

# 应该返回图片数量，例如: 3

# 2. 查看服务器日志
# 在终端中应该看到：
# [极致了API] - 图片数量: 3
# [飞书导出API] 开始并行处理图片...
# [飞书导出API] 成功上传 3/3 张图片
```

---

## 🔧 可能的修复方案

### 方案1: 修改字段名称（如果字段名不匹配）

如果你的飞书表格使用了不同的字段名，修改代码：

```typescript
// 修改 app/api/feishu/append-row/route.ts:256-261

// 例如，如果你的字段叫 "图片1", "图片2", "其他图片"
if (fileTokens[0]) recordFields['图片1'] = [{ file_token: fileTokens[0] }]
if (fileTokens[1]) recordFields['图片2'] = [{ file_token: fileTokens[1] }]
if (fileTokens.length > 2) {
  recordFields['其他图片'] = fileTokens.slice(2).map(token => ({ file_token: token }))
}
```

---

### 方案2: 增加详细日志（用于排查）

如果需要更详细的调试信息，可以在代码中添加：

```typescript
// 在 app/api/feishu/append-row/route.ts:256 之前添加
console.log('[飞书导出API] fileTokens数组:', fileTokens)
console.log('[飞书导出API] fileTokens长度:', fileTokens.length)

// 在写入后添加
console.log('[飞书导出API] 图片字段写入情况:')
if (recordFields['封面']) console.log('  - 封面: ✅')
if (recordFields['图片2']) console.log('  - 图片2: ✅')
if (recordFields['后续图片']) console.log('  - 后续图片: ✅')
```

---

### 方案3: 统一使用单个图片字段

如果飞书表格只有一个图片字段（可以存多张），修改代码：

```typescript
// 将所有图片都放到一个字段
if (fileTokens.length > 0) {
  recordFields['图片'] = fileTokens.map(token => ({ file_token: token }))
}
```

---

## ✅ 验证清单

完成排查后，使用此清单验证：

- [ ] 飞书表格有正确的图片字段（封面、图片2、后续图片）
- [ ] 字段类型是"附件"类型
- [ ] 使用有效的多图笔记链接测试
- [ ] Vercel 环境变量 `FEISHU_REFRESH_TOKEN` 已更新
- [ ] 图片能够正常显示在表格中
- [ ] 单图、双图、三图笔记都能正确显示

---

## 🎯 下一步

1. **首先**: 检查飞书表格的字段配置
2. **然后**: 使用一个新的、有效的多图笔记链接测试
3. **最后**: 根据测试结果确定具体问题

**请告诉我**:
1. 你的飞书表格图片字段叫什么名字？
2. 第67行那个笔记当时测试时有几张图片？
3. 你能提供一个新的、有效的多图笔记链接吗？

---

**创建时间**: 2026-02-05
**维护人**: Claude
