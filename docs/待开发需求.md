# 待开发需求列表

记录时间：2026-02-08

---

## 📋 需求1：发布管理与小红书复刻页面打通

### 需求描述
将小红书复刻页面的发布功能与发布管理页面打通，实现：
- 发布后自动保存到数据库
- 在发布管理中查看历史记录
- 支持二次发布
- 点击记录可跳转回复刻页面编辑
- 保存发布历史记录

### 功能清单

#### 1. 复刻页面发布时保存到数据库
- **难度：** ⭐⭐ (简单)
- **工作量：** 1-2小时
- **实现要点：**
  - 在 `handlePublish` 函数中，发布成功后调用 `/api/articles` 保存
  - 保存内容：title, content, images (JSON数组), tags, status, platforms
  - 添加 source 字段标识来源：`'xiaohongshu_rewrite'`
  - 返回 article_id 供后续使用

#### 2. 发布管理页面展示复刻记录
- **难度：** ⭐ (很简单)
- **工作量：** 0.5小时
- **实现要点：**
  - 现有 API `/api/articles` 已支持获取列表
  - 确保正确显示：标题、图片缩略图、发布状态、平台标签
  - 添加来源标识（复刻 / AI生成 / 自定义）

#### 3. 点击记录跳转回复刻页面并恢复内容 🔑
- **难度：** ⭐⭐⭐ (中等)
- **工作量：** 2-3小时
- **实现要点：**
  - 发布管理添加"编辑"按钮
  - 跳转到：`/rewrite?articleId=123`
  - 复刻页面支持 URL 参数：
    ```typescript
    const searchParams = useSearchParams()
    const articleId = searchParams.get('articleId')
    ```
  - 从 `/api/articles/${articleId}` 读取数据
  - 恢复内容：
    - ✅ 标题、正文、tags：直接赋值
    - ⚠️ 图片：从 URL 显示预览（不需要转换为 File）
  - 区分模式：`mode: 'new' | 'edit'`
  - 编辑模式下，更新文章而不是新建

#### 4. 二次发布功能
- **难度：** ⭐⭐ (简单)
- **工作量：** 1小时
- **实现要点：**
  - 发布管理页面添加"重新发布"按钮
  - 调用小红书发布 API：`/api/xiaohongshu/publish`
  - 更新数据库：published_at, status
  - 显示发布进度和结果

#### 5. 保留完整发布历史记录 ⚠️（可选）
- **难度：** ⭐⭐⭐⭐ (较难)
- **工作量：** 3-4小时
- **实现要点：**
  - 创建新表 `publish_history`：
    ```sql
    CREATE TABLE publish_history (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      article_id INTEGER NOT NULL,
      published_at INTEGER NOT NULL,
      status TEXT NOT NULL CHECK(status IN ('success', 'failed')),
      platform TEXT NOT NULL CHECK(platform IN ('xiaohongshu', 'wechat')),
      response_data TEXT,  -- API响应JSON
      error TEXT,
      created_at INTEGER NOT NULL,
      FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE
    )
    ```
  - 每次发布时插入记录
  - 文章详情页展示发布历史时间线
  - 支持查看每次发布的详细信息和错误

### 开发优先级
```
1️⃣ 发布时保存到数据库 (P0 - 基础)
   ↓
2️⃣ 发布管理展示记录 (P0 - 基础)
   ↓
3️⃣ 点击跳转并恢复内容 (P0 - 核心)
   ↓
4️⃣ 二次发布功能 (P1 - 重要)
   ↓
5️⃣ 发布历史记录 (P2 - 可选)
```

### 总体评估
- **总工作量：** 4-6小时（核心功能）/ 8-12小时（完整功能）
- **开发难度：** ⭐⭐⭐ (中等)
- **技术风险：**
  - 🟢 低风险：数据库操作、API调用
  - 🟡 中风险：图片URL处理、状态管理
  - 🟠 中高风险：发布历史表设计和关联查询

### 技术要点

#### 图片处理方案
```typescript
// 编辑模式：从URL显示预览，不需要转换为File
const [imageUrls, setImageUrls] = useState<string[]>([]) // 来自数据库
const [uploadedFiles, setUploadedFiles] = useState<File[]>([]) // 新上传的

// 发布时：
// 1. 如果是编辑模式且没有新上传，直接使用 imageUrls
// 2. 如果有新上传，合并 imageUrls 和新上传的URLs
```

#### 状态管理
```typescript
type PageMode = 'new' | 'edit'
const [pageMode, setPageMode] = useState<PageMode>('new')
const [currentArticleId, setCurrentArticleId] = useState<number | null>(null)
```

---

## 💬 需求2：小红书复刻页面支持多轮对话

### 需求描述
在小红书复刻页面添加多轮对话功能，支持用户对改写结果进行迭代优化（3-5轮）：
- 第1轮：解析原文并AI改写
- 第2轮：用户要求"再精简一点"
- 第3轮：用户要求"多加点表情"
- 第4-5轮：持续优化直到满意

### 功能清单

#### 1. 前端对话状态管理
- **难度：** ⭐⭐⭐ (中等)
- **工作量：** 2-3小时
- **实现要点：**
  ```typescript
  interface ConversationTurn {
    turn: number
    userPrompt: string  // 用户的要求（如"再精简一点"）
    aiResponse: {
      title: string
      content: string
    }
    timestamp: number
  }

  const [conversationHistory, setConversationHistory] = useState<ConversationTurn[]>([])
  ```
  - 保存每轮对话的输入和输出
  - 支持回退到某一轮
  - 支持从某一轮继续改写
  - localStorage 持久化（刷新后恢复）

#### 2. UI 展示对话历史
- **难度：** ⭐⭐ (简单)
- **工作量：** 1-2小时
- **实现要点：**
  - 左侧：对话历史时间线
  - 右侧：当前编辑内容
  - 每轮显示：轮次、用户要求、改写结果摘要
  - 支持点击某一轮查看完整内容
  - 添加"继续改写"输入框和按钮

#### 3. API 支持多轮对话
- **难度：** ⭐⭐⭐ (中等)
- **工作量：** 1-2小时
- **实现要点：**
  - 修改 `/api/xiaohongshu/rewrite`
  - 接收参数：
    ```typescript
    {
      title: string
      content: string
      titlePrompt: string
      contentPrompt: string
      conversationHistory?: ConversationTurn[]  // 新增
    }
    ```
  - 将历史上下文传给 Gemini API
  - Gemini API 支持多轮对话：
    ```typescript
    await geminiClient.models.generateContent({
      model: GEMINI_TEXT_MODEL,
      contents: [
        // 历史上下文
        ...conversationHistory.map(turn => ({
          role: 'user',
          parts: [{ text: turn.userPrompt }]
        })),
        // 当前请求
        { role: 'user', parts: [{ text: currentPrompt }] }
      ]
    })
    ```

#### 4. 回退和继续功能
- **难度：** ⭐⭐ (简单)
- **工作量：** 1小时
- **实现要点：**
  - 回退：恢复到选中轮次的内容，清除后续历史
  - 继续：基于当前内容和历史，发起新一轮改写
  - 限制最大轮次（如5轮），超过后提示用户

### 数据库方案（可选）

#### 不使用数据库（推荐）
- **优点：** 实现简单，速度快
- **缺点：** 刷新后丢失（可用 localStorage 缓解）
- **适用场景：** 3-5轮对话，临时性优化

#### 使用数据库（完整方案）
- **难度：** ⭐⭐⭐⭐ (较难)
- **工作量：** +2小时
- **实现要点：**
  ```sql
  CREATE TABLE rewrite_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT UNIQUE NOT NULL,
    original_title TEXT NOT NULL,
    original_content TEXT NOT NULL,
    conversation_history TEXT NOT NULL,  -- JSON
    current_title TEXT NOT NULL,
    current_content TEXT NOT NULL,
    images TEXT DEFAULT '[]',
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    expires_at INTEGER NOT NULL  -- 7天后过期
  )
  ```
  - 复用 `image_sessions` 的会话管理机制
  - 设置过期时间（7天），定期清理
  - 可以跨设备访问
  - 支持断点续传

### 开发优先级
```
1️⃣ 前端对话状态管理 (P0 - 核心)
   ↓
2️⃣ API 支持多轮对话 (P0 - 核心)
   ↓
3️⃣ UI 展示对话历史 (P1 - 重要)
   ↓
4️⃣ 回退和继续功能 (P1 - 重要)
   ↓
5️⃣ 数据库持久化 (P2 - 可选)
```

### 总体评估
- **总工作量：** 4-6小时（前端方案）/ 6-8小时（数据库方案）
- **开发难度：** ⭐⭐⭐⭐ (中等偏难)
- **推荐方案：** 先用前端方案快速上线，验证需求后再考虑数据库

### 数据库复用分析

#### ✅ 可以复用的部分
1. **会话管理机制**（参考 `image_sessions`）
   - session_id 生成
   - expires_at 过期机制
   - 定期清理过期会话

2. **对话历史存储方式**
   - conversation_history 字段（JSON格式）
   - 存储结构和查询方式

#### 🔗 与发布管理的关联
```
rewrite_sessions (改写过程)
        ↓
   最终确认发布
        ↓
articles (发布内容) ← publish_history (发布历史)
```

可以添加关联：
- `rewrite_sessions.article_id` → `articles.id`
- 发布后，将 session_id 保存到 articles 表，方便追溯改写过程

---

## 📊 两个需求的关系

```
┌─────────────────────────────────────────────┐
│         小红书复刻页面                        │
│  ┌──────────────────────────────────────┐  │
│  │  1. 解析链接 / 从数据库加载            │  │
│  │  2. 多轮对话改写（需求2）              │  │
│  │  3. 添加表情                          │  │
│  │  4. 发布 → 保存到数据库（需求1）      │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│           articles 数据库                    │
│  - 保存最终发布的内容                        │
│  - 支持编辑和二次发布（需求1）               │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│         发布管理页面                          │
│  - 展示历史记录                              │
│  - 跳转回复刻页面编辑（需求1）               │
│  - 二次发布                                 │
└─────────────────────────────────────────────┘
```

### 数据库表关系（如果都实现）
```sql
-- 改写会话表（需求2 - 可选）
rewrite_sessions
  ├─ session_id (主键)
  ├─ conversation_history (对话历史)
  └─ article_id (外键) ──┐
                          │
-- 文章表（需求1 - 必须） │
articles ◄─────────────────┘
  ├─ id (主键)
  ├─ title, content, images
  └─ 被 publish_history 关联
          │
-- 发布历史表（需求1 - 可选）
publish_history
  ├─ id (主键)
  ├─ article_id (外键)
  └─ published_at, status, platform
```

---

## 🎯 建议的开发顺序

### 阶段1：基础功能（优先级最高）
1. **需求1 - 第1-3项**：发布保存、展示、跳转编辑
   - 工作量：3-4小时
   - 让基本流程跑通

### 阶段2：增强功能（短期规划）
2. **需求2 - 第1-3项**：多轮对话（前端方案）
   - 工作量：4-6小时
   - 提升改写体验

3. **需求1 - 第4项**：二次发布
   - 工作量：1小时
   - 完善发布管理

### 阶段3：完善功能（长期优化）
4. **需求1 - 第5项**：发布历史记录
   - 工作量：3-4小时
   - 数据追踪和分析

5. **需求2 - 第5项**：多轮对话数据库持久化
   - 工作量：2小时
   - 跨设备访问和断点续传

---

## 📝 备注

- 两个需求相对独立，可以分开开发
- 建议先实现需求1的核心功能，打通数据流
- 需求2可以先用前端方案快速验证，再决定是否需要数据库
- 如果都要实现数据库方案，可以复用会话管理机制

---

**文档创建时间：** 2026-02-08
**最后更新：** 2026-02-08
**状态：** 待开发
