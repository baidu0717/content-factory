# 代码进度记录

**日期：** 2026-02-08
**记录人：** Claude Sonnet 4.5

---

## 📦 当前项目状态

### 项目概况
- **项目名称：** 内容工厂 Agent
- **技术栈：** Next.js 16 + TypeScript + Tailwind CSS + SQLite
- **部署平台：** Vercel
- **主要功能：**
  - 小红书笔记复刻与改写
  - 小红书笔记采集
  - AI 生图（Gemini Imagen）
  - 发布管理
  - 批量采集

---

## 🔄 本次开发周期完成的功能

### 1. 侧边栏抽屉效果优化 ✅
**相关文件：**
- `components/Sidebar.tsx`
- `app/layout.tsx`

**改动内容：**
- 侧边栏改为完全隐藏（translate-x-full）而非缩小到16px
- 添加左侧4px宽触发区域，鼠标移到左侧时侧边栏滑出
- 移除主内容区左边距（lg:ml-16），让内容区占据全屏
- 侧边栏文本始终显示完整，不再根据hover状态隐藏

**提交记录：**
- `fix: 修复侧边栏隐藏和表情按钮显示问题`
- `fix: 修复侧边栏触发和表情按钮布局`

---

### 2. 小红书表情系统 ✅
**相关文件：**
- `lib/xiaohongshu-emojis.ts` (新建)
- `lib/emoji-learning.ts` (新建)
- `components/XHSEmojiPicker.tsx` (新建)
- `components/XHSEmojiTextEditor.tsx` (新建)
- `app/api/xiaohongshu/rewrite/route.ts` (修改)
- `app/rewrite/page.tsx` (修改)

**改动内容：**

#### 2.1 表情数据库
- 创建包含 50+ 小红书官方表情的数据库
- 表情格式：`[表情名R]`（如 `[萌萌哒R]`、`[笑哭R]`）
- 支持分类：表情、手势、动作、情绪、可爱、其他
- 支持按名称和拼音搜索
- 提供热门表情推荐

#### 2.2 表情选择器
- 紧凑型设计：320px 宽，8列网格
- 支持分类浏览和搜索
- 表情图标 24px，hover 显示名称
- 表情选择器右对齐，贴合文本框边缘
- 删除底部使用提示，界面更精简

#### 2.3 表情文本编辑器
- 表情按钮独立一行，位于文本框上方右侧
- 按钮浮动显示（40x40px，白色背景，带阴影）
- 点击按钮弹出表情选择器
- 支持在光标位置插入表情代码
- 显示表情统计和字数统计

#### 2.4 AI 自动添加表情
- 修改改写 API，在提示词中添加表情使用指南
- 标题：建议 0-2 个表情
- 正文：建议 5-8 个表情，每段 1-2 个
- 提供常用表情列表和使用场景
- Gemini 自动在合适位置插入表情代码

**提交记录：**
- `refactor: 统一页面状态并精简表情按钮`
- `refactor: 优化表情选择器 - 更紧凑贴合`
- `refactor: 表情按钮独立成行，右对齐显示`

---

### 3. 页面布局优化 ✅
**相关文件：**
- `app/rewrite/page.tsx`

**改动内容：**
- 移除"等待解析小红书链接"的空状态
- 从内容工厂点击进入时，直接显示完整编辑界面
- 统一从内容工厂和从飞书表格进入的页面布局
- 图片上传、改写设置、内容编辑区域始终显示
- 用户可以直接输入内容，无需先解析链接

**提交记录：**
- `refactor: 统一页面状态并精简表情按钮`
- `fix: 修复 TypeScript 类型错误`

---

## 📂 项目结构

```
/Users/baidu/Desktop/第四次直播代码/
├── app/
│   ├── api/
│   │   └── xiaohongshu/
│   │       ├── parse/           # 解析小红书链接
│   │       ├── rewrite/         # AI改写（已添加表情支持）
│   │       ├── publish/         # 发布到小红书
│   │       └── quick-save/      # 快速保存到飞书
│   ├── rewrite/                 # 小红书复刻页面
│   ├── publish/                 # 发布管理页面
│   ├── collect/                 # 批量采集页面
│   ├── xiaohongshu-extract/     # 小红书采集页面
│   └── image-generate/          # AI生图页面
├── components/
│   ├── Sidebar.tsx              # 侧边栏（已优化）
│   ├── XHSEmojiPicker.tsx       # 表情选择器（新建）
│   ├── XHSEmojiTextEditor.tsx   # 表情文本编辑器（新建）
│   └── ...
├── lib/
│   ├── db.ts                    # 数据库连接和表初始化
│   ├── xiaohongshu-emojis.ts    # 表情数据库（新建）
│   ├── emoji-learning.ts        # 表情学习系统（新建）
│   └── ...
└── docs/
    ├── 待开发需求.md             # 需求文档（本次创建）
    └── 代码进度-2026-02-08.md   # 本文档
```

---

## 🗄️ 数据库结构（SQLite）

### 现有表

#### 1. articles - 文章表
```sql
CREATE TABLE articles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'draft',
  platforms TEXT DEFAULT '[]',
  source TEXT NOT NULL DEFAULT 'ai_generated',
  created_at INTEGER NOT NULL,
  published_at INTEGER,
  stats TEXT,
  tags TEXT DEFAULT '[]',
  error TEXT,
  word_count INTEGER,
  reading_time INTEGER,
  images TEXT DEFAULT '[]',  -- JSON数组，存储图片URLs
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

#### 2. search_history - 搜索历史表
```sql
CREATE TABLE search_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  keyword TEXT NOT NULL,
  platform TEXT NOT NULL,
  timestamp INTEGER NOT NULL,
  result_count INTEGER DEFAULT 0,
  articles_data TEXT,
  api_response TEXT,
  ai_insights TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

#### 3. feishu_notes - 飞书笔记表
```sql
CREATE TABLE feishu_notes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  url TEXT NOT NULL,
  tags TEXT,
  images TEXT,
  rewrite_status TEXT DEFAULT 'pending',
  created_at INTEGER NOT NULL,
  rewritten_at INTEGER,
  article_id INTEGER
)
```

#### 4. image_sessions - 图片生成会话表
```sql
CREATE TABLE image_sessions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT UNIQUE NOT NULL,
  model TEXT NOT NULL,
  mode TEXT NOT NULL,
  conversation_history TEXT,
  last_image_url TEXT,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  expires_at INTEGER NOT NULL
)
```

#### 5. image_history - 图片历史记录表
```sql
CREATE TABLE image_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT,
  turn_number INTEGER NOT NULL DEFAULT 1,
  model TEXT NOT NULL,
  mode TEXT NOT NULL,
  prompt TEXT NOT NULL,
  image_url TEXT NOT NULL,
  aspect_ratio TEXT,
  resolution TEXT,
  duration INTEGER,
  created_at INTEGER NOT NULL
)
```

---

## 🔧 技术细节

### 1. 表情系统实现

**表情代码格式：**
```typescript
// 小红书表情格式
[萌萌哒R]  // 萌萌哒
[笑哭R]    // 笑哭
[赞R]      // 赞
[火R]      // 火
```

**表情数据结构：**
```typescript
interface XHSEmoji {
  code: string        // [萌萌哒R]
  name: string        // 萌萌哒
  pinyin: string      // mengmengda
  imageUrl?: string   // CDN URL（可选）
  category: string    // 分类
  tags?: string[]     // 标签
  isHot?: boolean     // 是否热门
}
```

**CDN 图片 URL 模式：**
```
https://fe-static.xhscdn.com/formula-static/walle-eva/public/img/xy_emotion_redclub_*.png
```

### 2. AI 改写流程

```typescript
// 1. 用户输入原文
// 2. AI 第一次改写（自动添加表情）
const rewriteResponse = await fetch('/api/xiaohongshu/rewrite', {
  method: 'POST',
  body: JSON.stringify({
    title: originalTitle,
    content: originalContent,
    titlePrompt: '...',
    contentPrompt: '...'  // 包含表情使用指南
  })
})

// 3. 用户在编辑器中继续调整，可以手动添加/删除表情
// 4. 点击发布
```

### 3. Gemini API 配置

**当前使用：**
- 模型：`gemini-3-pro-preview`
- 温度：标题 1.0，正文 0.9（高创造性）
- topP: 0.95
- topK: 40
- 最大 Token：标题 2000，正文 8192

**多轮对话支持（待实现）：**
```typescript
await geminiClient.models.generateContent({
  model: GEMINI_TEXT_MODEL,
  contents: [
    // 历史上下文
    ...conversationHistory.map(turn => ({
      role: 'user',
      parts: [{ text: turn.userPrompt }]
    })),
    // 当前请求
    { role: 'user', parts: [{ text: currentPrompt }] }
  ],
  config: { temperature: 0.9, topP: 0.95, topK: 40 }
})
```

---

## 🐛 已知问题和限制

### 1. 表情系统
- ✅ 表情代码可以正常插入
- ✅ 字数统计包含表情代码
- ⚠️ 表情图片不在网页预览中显示（只在小红书 app 中显示）
- ⚠️ 需要用户在小红书 app 中查看实际效果

### 2. 图片处理
- ✅ 支持上传本地图片
- ✅ 支持拖拽排序
- ⚠️ 从数据库恢复时，图片是 URL 格式（待实现：需求1）
- ⚠️ 需要将 URL 显示为预览，而不是转换为 File 对象

### 3. 发布功能
- ✅ 可以发布到小红书
- ❌ 发布后不保存到数据库（待实现：需求1）
- ❌ 无法查看历史记录（待实现：需求1）
- ❌ 无法二次编辑和发布（待实现：需求1）

### 4. 多轮对话
- ❌ 不支持多轮对话改写（待实现：需求2）
- ❌ 不支持回退到之前的版本（待实现：需求2）
- ⚠️ 当前只有历史版本功能（手动编辑的快照）

---

## 📊 代码统计

### 最近提交记录
```bash
git log --oneline -10
```

```
2176d6d refactor: 表情按钮独立成行，右对齐显示
1ae5f7e refactor: 优化表情选择器 - 更紧凑贴合
0f7b3ed fix: 修复 TypeScript 类型错误
2897e77 refactor: 统一页面状态并精简表情按钮
65181ab fix: 修复侧边栏触发和表情按钮布局
3521af1 fix: 修复侧边栏隐藏和表情按钮显示问题
672973f (前面的提交...)
```

### 文件变更统计
- 新增文件：4 个
  - `lib/xiaohongshu-emojis.ts`
  - `lib/emoji-learning.ts`
  - `components/XHSEmojiPicker.tsx`
  - `components/XHSEmojiTextEditor.tsx`

- 修改文件：5 个
  - `app/rewrite/page.tsx`
  - `app/layout.tsx`
  - `components/Sidebar.tsx`
  - `app/api/xiaohongshu/rewrite/route.ts`

- 代码行数变化：
  - 新增：约 800 行
  - 删除：约 150 行
  - 净增：约 650 行

---

## 🎯 下一步计划

### 短期（1-2周）
1. **需求1：发布管理打通**（优先级 P0）
   - 实现发布时保存到数据库
   - 发布管理页面展示历史记录
   - 支持点击跳转回复刻页面编辑
   - 支持二次发布

2. **需求2：多轮对话**（优先级 P1）
   - 前端状态管理（3-5轮对话）
   - API 支持多轮对话
   - UI 展示对话历史

### 中期（3-4周）
3. **完善发布历史记录**
   - 创建 publish_history 表
   - 展示详细发布记录
   - 支持查看每次发布的API响应

4. **多轮对话持久化**
   - 创建 rewrite_sessions 表
   - 支持跨设备访问
   - 支持断点续传

### 长期（1-2个月）
5. **表情系统优化**
   - 添加更多表情
   - 表情使用统计和推荐
   - 个性化表情偏好学习

6. **性能优化**
   - 图片上传优化
   - 数据库查询优化
   - 缓存策略优化

---

## 🔒 环境变量配置

### 必需的环境变量
```env
# Gemini API（文本生成和改写）
GEMINI_TEXT_API_KEY=your_gemini_api_key
GEMINI_TEXT_MODEL=gemini-3-pro-preview

# Gemini API（图片生成）
GEMINI_IMAGE_API_KEY=your_gemini_api_key

# 小红书发布 API
MYAIBOT_API_KEY=your_myaibot_api_key

# 飞书 Webhook
FEISHU_WEBHOOK_URL=your_feishu_webhook_url

# 代理（可选，本地开发用）
HTTPS_PROXY=http://127.0.0.1:7890
HTTP_PROXY=http://127.0.0.1:7890
```

### Vercel Blob（图片存储）
- 自动配置，无需手动设置
- 通过 `@vercel/blob` SDK 使用

---

## 📝 备注

### 开发环境
- Node.js: v18+
- npm: v9+
- 操作系统: macOS (Darwin 24.6.0)

### 部署信息
- 平台: Vercel
- 自动部署: main 分支 push 时触发
- 构建命令: `npm run build`
- 输出目录: `.next`

### Git 配置提醒
```bash
# 配置用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

### 代码风格
- TypeScript 严格模式
- ESLint + Prettier
- Tailwind CSS 实用优先
- React Hooks 编码规范

---

**文档创建时间：** 2026-02-08 22:30
**Git Commit：** 2176d6d
**分支：** main
**状态：** ✅ 已部署到生产环境
