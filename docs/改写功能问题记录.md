# 改写功能问题记录

**创建时间**: 2026-02-06
**当前状态**: 正文改写正常，标题改写返回相同标题

---

## 问题概述

内容工厂的复刻页面 (`/rewrite`) 提供了标题和正文的 AI 改写功能，使用 Gemini API 进行内容改写。目前正文改写功能正常，但标题改写存在问题。

---

## 核心问题

### ❌ 问题1: 标题改写返回相同标题

**症状**:
- 点击"改写标题"按钮后，API 调用成功
- 但返回的新标题与原标题完全相同
- 正文改写功能正常（197字 → 698字）

**测试案例**:
```
原标题: 落地五渔村我懵了…
新标题: 落地五渔村我懵了…  ❌ 完全相同
```

**前端日志**:
```javascript
[改写标题] 开始改写标题
[改写标题] 当前标题: 落地五渔村我懵了…
[改写标题] API返回结果: {success: true, data: {...}}
[改写标题] 新标题: 落地五渔村我懵了…  // 相同！
```

---

## 已排查的可能原因

### ✅ 已排除的问题

1. **模型名称错误** ❌
   - 当前使用: `gemini-3-pro-preview`
   - 排除原因: 正文改写成功，说明模型工作正常

2. **API 调用失败** ❌
   - API 返回 `success: true`
   - 说明调用成功，只是返回内容相同

3. **参数传递问题** ❌
   - 已确认 `titlePrompt` 正确传递到后端
   - 代码路径: `app/rewrite/page.tsx:369` → API

4. **提示词未生效** ❌
   - 已改为完全自定义模式
   - 用户修改的提示词直接发给 AI

### 🤔 可能的原因

1. **Gemini 模型理解问题**
   - 模型可能认为原标题已经足够好，不需要改写
   - 或者过于"保守"地保持原意

2. **提示词表达不够明确**
   - 当前提示词:
     ```
     你是小红书爆款标题创作专家。请创作一个完全不同的新标题，
     要求：1) 不使用原标题的词汇和句式 2) 使用数字、emoji或悬念手法
     3) 长度10-20字 4) 只输出标题本身

     原标题：落地五渔村我懵了…

     请创作一个新标题：
     ```

3. **Temperature 设置**
   - 当前 `temperature: 0.9`
   - 已经较高，但可能还需要调整

---

## 已实施的修复尝试

### 修复1: 优化提示词 (commit: 7be1e68)
- **时间**: 2026-02-06 22:xx
- **内容**: 添加结构化提示词模板，强调"创作全新标题"
- **结果**: 待测试

### 修复2: 改为完全自定义模式 (commit: 43cbf88)
- **时间**: 2026-02-06 22:xx
- **内容**:
  - 移除后端固定模板
  - 用户修改的提示词直接发给 Gemini
  - 前端优化默认提示词
- **结果**: 待测试

### 修复3: 提高 temperature (commit: 7103b64)
- **时间**: 2026-02-06 22:xx
- **内容**: 将 `temperature` 从 0.8 提升到 0.9
- **结果**: 待测试

### 修复4: 增加详细日志 (commit: 7103b64)
- **时间**: 2026-02-06 22:xx
- **内容**:
  - 记录完整提示词
  - 记录 Gemini 返回结果
  - 记录标题是否改变
- **目的**: 用于排查 Gemini 实际返回内容

---

## 相关代码文件

### 前端
- **文件**: `app/rewrite/page.tsx`
- **关键函数**: `handleRewriteTitle()` (line 358-387)
- **提示词状态**: `titlePrompt` (line 340)
- **API 调用**: line 363-371

```typescript
// 关键代码
const response = await fetch('/api/xiaohongshu/rewrite', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    title: editableTitle,
    titlePrompt: titlePrompt  // 用户自定义提示词
  })
})
```

### 后端
- **文件**: `app/api/xiaohongshu/rewrite/route.ts`
- **关键逻辑**: line 53-103
- **Gemini 配置**:
  - Model: `gemini-3-pro-preview`
  - Temperature: `0.9`
  - MaxTokens: `500`

```typescript
// 当前提示词构建
const titleContents = [{
  role: 'user',
  parts: [{
    text: `${titlePrompt}\n\n原标题：${title}\n\n请创作一个新标题：`
  }]
}]
```

---

## 次要问题

### ✅ 已修复: 单独改写标题时报错

**问题**: 点击"改写标题"按钮时，API 返回 500 错误
```
Cannot read properties of undefined (reading 'replace')
```

**原因**:
- 单独改写标题时不传 `content`
- 但后端代码对 `newContent.replace()` 没有空值检查

**修复**: (commit: 942a7cf)
```typescript
// 修复前
const wordCount = newContent.replace(/\s/g, '').length  // ❌

// 修复后
const wordCount = newContent ? newContent.replace(/\s/g, '').length : 0  // ✅
```

### ✅ 已修复: 单独改写标题会同时修改正文

**问题**: 点击"改写标题"按钮，正文也被改写但结果被丢弃

**原因**: `handleRewriteTitle()` 传递了 `content` 和 `contentPrompt`

**修复**: (commit: 7103b64)
```typescript
// 修复前
body: JSON.stringify({
  title: editableTitle,
  content: editableContent,  // ❌ 不应该传
  titlePrompt: titlePrompt,
  contentPrompt: contentPrompt  // ❌ 不应该传
})

// 修复后
body: JSON.stringify({
  title: editableTitle,
  titlePrompt: titlePrompt  // ✅ 只传标题相关
})
```

---

## 待测试验证

1. **查看 Vercel 服务器日志**
   - 等待部署完成 (commit: 43cbf88)
   - 查看 `[内容改写]` 相关日志
   - 确认 Gemini 实际返回的内容

2. **测试新提示词效果**
   - 使用默认提示词测试
   - 尝试修改提示词为更强硬的表达
   - 多测试几个不同的标题

3. **考虑替代方案**
   - 如果 Gemini 持续返回相同标题，考虑：
     - 更换模型 (`gemini-2.0-flash-exp`)
     - 使用 DeepSeek API
     - 增加示例 (few-shot learning)

---

## 环境配置

### Gemini API
```env
GEMINI_TEXT_API_KEY=AIzaSyCZ6cx5BM4i_ikYoad-IJ12cFMe-pdPLu8
GEMINI_TEXT_MODEL=gemini-3-pro-preview
```

### 部署环境
- **平台**: Vercel
- **域名**: https://content-factory-jade-nine.vercel.app
- **复刻页面**: https://content-factory-jade-nine.vercel.app/rewrite

---

## 用户反馈

### 按钮禁用行为
**反馈**: 点击"改写标题"时，其他按钮也变灰了

**说明**: 这是**正常设计**，目的是：
- 防止并发请求冲突
- 保护 API 配额
- 清晰的状态反馈

**代码位置**: `app/rewrite/page.tsx:819, 838, 876`
```typescript
disabled={!editableTitle || processingStep !== ''}
```

---

## 下一步行动

### 立即行动
- [ ] 等待 Vercel 部署完成
- [ ] 硬刷新浏览器清除缓存
- [ ] 测试标题改写功能
- [ ] 查看 Vercel 服务器日志中的 `[内容改写]` 信息

### 如果标题仍相同
- [ ] 截图 Vercel 日志中的完整提示词和返回内容
- [ ] 尝试更换 Gemini 模型为 `gemini-2.0-flash-exp`
- [ ] 考虑在提示词中增加示例 (few-shot)
- [ ] 评估是否切换到 DeepSeek API

### 优化建议
- [ ] 添加"重新生成"按钮（可以用不同的 temperature 再试一次）
- [ ] 显示改写前后的对比
- [ ] 提供多个标题选项供用户选择

---

## 技术栈

- **AI 模型**: Google Gemini (gemini-3-pro-preview)
- **前端框架**: Next.js 14 (App Router)
- **编程语言**: TypeScript
- **UI 框架**: Tailwind CSS + Framer Motion
- **部署平台**: Vercel

---

## 相关文档

- [Gemini API 文档](https://ai.google.dev/docs)
- [Next.js App Router](https://nextjs.org/docs/app)
- [项目 README](../README.md)

---

**最后更新**: 2026-02-06
**维护者**: Claude Code
