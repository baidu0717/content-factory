# 2026-02-06 工作总结：API Key 泄露修复与提示词优化

**日期**：2026-02-06
**工作时长**：约 3-4 小时
**主要任务**：安全漏洞修复、标题改写功能优化、UI 交互改进

---

## 📋 完成的工作

### 1. ✅ API Key 泄露安全问题（紧急修复）

**问题发现**：
- Google Cloud Platform 发送安全警告邮件
- Gemini API Key 被泄露到 GitHub 公开仓库
- 文件位置：`docs/改写功能问题记录.md:224`
- Google 自动禁用了泄露的 key

**修复步骤**：
1. ✅ 在 Google Cloud Console 生成新的 API Key
2. ✅ 配置安全限制：
   - 应用限制：网站（`content-factory-jade-nine.vercel.app/*`）
   - API 限制：仅 Generative Language API
3. ✅ 更新本地 `.env.local` 配置
4. ✅ 更新 Vercel 环境变量
5. ✅ 从文档中移除 API Key 明文
6. ✅ 提交到 Git 并推送

**相关 Commit**：
- `39388ca` - security: 从文档中移除泄露的 API key

---

### 2. ✅ 标题改写功能修复（核心问题）

**问题描述**：
- 标题改写一直返回与原标题相同的内容
- Vercel 日志显示：`finishReason: MAX_TOKENS`
- 根本原因：配置参数问题 + 提示词不够明确

**修复历程**：

#### 尝试 1：修改配置参数名称（失败）
- 错误地将 `config` 改为 `generationConfig`
- 导致 TypeScript 编译错误
- Vercel 部署失败
- **结果**：回滚修改

#### 尝试 2：移除后端固定提示词
- 将后端添加的固定示例移到前端
- 让用户拥有 100% 的提示词控制权
- **结果**：仍然返回相同标题

#### 尝试 3：优化提示词格式
- 调整示例格式：`参考示例` → `示例1/示例2`
- 添加行动指令：`现在轮到你了：`
- **结果**：仍然失败

#### 尝试 4：强化提示词指令（成功！✅）
- 添加强硬的禁止指令：
  ```
  【重要】必须创作一个与原标题完全不同的新标题！
  严禁直接复制原标题！
  ```
- 更换示例内容（避免与测试标题相似）
- 明确的行动指令：`现在轮到你创作：`
- **结果**：成功生成不同的标题！

**测试结果**：
```
原标题：落地五渔村我懵了…
新标题：⚠️千万别盲目去五渔村！这3个教训太痛了…
✅ 完全不同！
```

**相关 Commit**：
- `316675a` - fix: 修复标题改写 MAX_TOKENS 错误（失败，被回滚）
- `a7db605` - fix: 回滚错误修改并优化标题改写提示词
- `b9e72ec` - fix: 优化标题改写提示词格式
- `5036214` - refactor: 前端提示词完全生效 - 移除后端固定提示词
- `c7d6582` - fix: 强化标题改写提示词 - 明确禁止复制原标题

---

### 3. ✅ UI 交互优化（用户体验改进）

**用户需求**：
- 点击"改写标题"时，其他按钮（"改写正文"、"一键改写全部"）也会变灰
- 用户希望每个按钮独立控制

**实现方案**：
1. 替换单一的 `processingStep` 状态为三个独立的布尔状态：
   - `isRewritingTitle`
   - `isRewritingContent`
   - `isRewritingAll`

2. 更新按钮的 `disabled` 逻辑：
   ```typescript
   // 之前：所有按钮共享状态
   disabled={processingStep !== ''}

   // 现在：独立控制
   disabled={isRewritingTitle}
   ```

3. 按钮文本动态显示加载状态：
   ```typescript
   {isRewritingTitle ? '改写中...' : '改写标题'}
   ```

**用户体验提升**：
- ✅ 可以同时操作不同部分
- ✅ 更清晰的加载状态反馈
- ✅ 更灵活的操作方式

**相关 Commit**：
- `230024c` - feat: 优化按钮交互 - 改为独立禁用控制

---

### 4. ✅ API 参数优化（接近官网效果）

**用户反馈**：
- API 调用效果不如 Gemini 官网聊天界面
- 官网生成质量更好、更稳定

**原因分析**：
1. 官网有隐藏的系统提示词和优化
2. 官网可能使用更丰富的参数配置
3. 官网有对话上下文，API 是无状态调用
4. 参数差异导致输出质量不同

**优化方案**：
添加更多 API 参数来接近官网效果：

**标题改写参数**：
```javascript
{
  temperature: 0.9 → 1.0,    // 最大创造性
  topP: 0.95,                // 增加输出多样性
  topK: 40,                  // 扩大候选词范围
  maxOutputTokens: 2000,
  candidateCount: 1
}
```

**正文改写参数**：
```javascript
{
  temperature: 0.8 → 0.9,
  topP: 0.95,
  topK: 40,
  maxOutputTokens: 8192
}
```

**相关 Commit**：
- `0d64069` - improve: 优化 Gemini API 参数 - 接近官网效果

---

## 🎯 技术亮点

### 1. Few-shot Learning 应用
- 通过提供具体示例，让 AI 理解期望的输出格式
- 示例选择很重要：避免与测试内容太相似

### 2. 强化学习提示词工程
- 明确的禁止指令比温和的建议更有效
- 行动指令帮助 AI 理解何时输出

### 3. 独立状态管理
- 用多个布尔状态替代单一状态
- 提升用户体验和代码可维护性

### 4. API 参数调优
- `temperature`: 控制创造性
- `topP/topK`: 控制输出多样性
- 参数组合对结果影响很大

---

## 📊 代码统计

**提交次数**：8 次
**修改文件**：
- `app/api/xiaohongshu/rewrite/route.ts` (后端 API)
- `app/rewrite/page.tsx` (前端页面)
- `docs/改写功能问题记录.md` (文档)

**代码行数变化**：
```
+120 行
-85 行
```

---

## ❓ 当前遗留问题

### 问题 1：页面出现乱码
- **描述**：用户反馈页面显示乱码
- **状态**：待排查
- **可能原因**：
  - 浏览器缓存问题
  - 字符编码问题
  - JS 文件损坏
- **建议**：
  1. 清除浏览器缓存
  2. 硬刷新页面（Ctrl+Shift+R）
  3. 检查网络请求是否正常加载

### 问题 2：API 参数配置策略（待讨论）

**核心问题**：是否需要将 API 参数调整得和官网模型参数一样？

**两种策略分析**：

#### 策略 A：模仿官网参数 ⚖️

**优点**：
- ✅ 接近官网的用户体验
- ✅ 参数经过 Google 优化
- ✅ 减少参数调试时间

**缺点**：
- ❌ 无法确定官网实际使用的参数
- ❌ 官网可能有后处理逻辑
- ❌ 一刀切，不考虑具体场景

**推荐场景**：
- 不确定如何配置参数时
- 追求稳定和可预测的输出
- 开发初期快速上线

---

#### 策略 B：个性化调整参数 🎯

**优点**：
- ✅ 针对具体场景优化
- ✅ 更好地控制输出质量
- ✅ 可以 A/B 测试找到最佳配置

**缺点**：
- ❌ 需要大量测试和调优
- ❌ 需要理解每个参数的作用
- ❌ 可能不稳定

**推荐场景**：
- 有明确的质量要求
- 需要特定的输出风格
- 有资源做深度优化

---

#### 我的建议 💡

**短期（当前阶段）**：
```javascript
// 使用接近官网的参数作为基准
标题改写：
- temperature: 1.0
- topP: 0.95
- topK: 40

正文改写：
- temperature: 0.9
- topP: 0.95
- topK: 40
```

**中期（有用户反馈后）**：
1. 收集用户对改写质量的反馈
2. A/B 测试不同参数组合
3. 针对"标题"和"正文"分别优化

**长期（产品成熟后）**：
1. 提供多种风格模板：
   - 爆款风格（高 temperature）
   - 专业风格（低 temperature）
   - 幽默风格（特定提示词 + 中等 temperature）
2. 让用户自定义参数（高级功能）
3. 基于用户反馈动态调整

---

#### 具体场景的参数建议

**小红书标题（爆款）**：
```javascript
{
  temperature: 1.0,      // 高创造性
  topP: 0.95,           // 多样化
  topK: 40,
  maxOutputTokens: 100   // 标题不需要太多 tokens
}
```

**小红书正文（原创）**：
```javascript
{
  temperature: 0.9,      // 稍低，保持连贯性
  topP: 0.95,
  topK: 40,
  maxOutputTokens: 8192
}
```

**专业文档翻译**：
```javascript
{
  temperature: 0.3,      // 低随机性，准确性优先
  topP: 0.9,
  topK: 20,
  maxOutputTokens: 4096
}
```

**创意文案生成**：
```javascript
{
  temperature: 1.2,      // 极高创造性
  topP: 0.98,
  topK: 60,
  candidateCount: 3      // 生成多个候选，选最好的
}
```

---

### 问题 3：MAX_TOKENS 错误可能再次出现

**现状**：
- 通过强化提示词暂时解决
- 但根本原因（为什么会 MAX_TOKENS）未完全查明

**建议**：
1. 监控 Vercel 日志中的 `finishReason`
2. 如果频繁出现 MAX_TOKENS：
   - 考虑增加 `maxOutputTokens`
   - 或简化提示词
   - 或更换模型

---

## 📝 下次工作建议

### 高优先级
1. 🔍 排查页面乱码问题
2. 📊 收集用户对改写质量的反馈
3. 🧪 测试不同提示词模板的效果

### 中优先级
4. 📈 添加改写质量监控（记录成功率、用户满意度）
5. 🎨 提供多种风格模板供用户选择
6. 💾 保存用户常用的提示词模板

### 低优先级
7. 🔄 实现提示词版本管理
8. 📖 编写用户使用文档
9. 🤖 考虑添加其他 AI 模型支持（DeepSeek、Claude 等）

---

## 🎓 今日学到的经验

### 1. 安全第一
- API Key 永远不要写入代码或文档
- 使用环境变量 + `.gitignore`
- 定期审查 Git 历史

### 2. AI 提示词工程
- 强硬明确的指令比委婉建议更有效
- 示例选择要考虑与实际内容的相似度
- 格式化和结构化提示词很重要

### 3. 用户体验优先
- 独立的按钮状态比全局状态更灵活
- 加载状态反馈要清晰
- 用户反馈是最好的优化方向

### 4. API 参数调优
- 不同任务需要不同参数
- 官网参数可以作为参考基准
- 需要通过实验找到最佳配置

---

## 📚 参考资料

- [Gemini API 文档](https://ai.google.dev/gemini-api/docs/models/generative-models)
- [提示词工程指南](https://www.promptingguide.ai/)
- [Google AI Studio](https://aistudio.google.com/)

---

**文档维护者**：Claude Code
**最后更新**：2026-02-06 23:30
