# 飞书 Token 监控配置指南

## 📅 更新时间
2026年2月2日

---

## 🎯 目标

自动监控飞书 `refresh_token` 的有效期，在即将过期或已过期时通过邮件提醒。

---

## ✅ 已完成的工作

### 1. 移除 Upstash Redis 依赖
- ✅ 删除 `@vercel/kv` npm 包
- ✅ 简化 `lib/feishuAuth.ts`，改用环境变量 + 内存缓存
- ✅ 更新 `.env.local`，注释掉 KV 相关配置

**优点：**
- 架构更简单，无需维护 Redis 数据库
- 本地和线上配置一致
- 成本为零

**注意事项：**
- refresh_token 需要每30天手动更新一次（通过邮件提醒）
- Vercel 实例重启后需要重新刷新 token（首次请求稍慢，后续缓存）

### 2. 创建 Token 过期监控 API
**文件：** `app/api/monitor/feishu-token/route.ts`

**功能：**
- 每天自动检查 refresh_token 是否有效
- 检测到以下情况会发送邮件：
  - ⚠️ Token 已失效（立即告警）
  - ⏰ Token 将在 7 天内过期（提前提醒）
  - ❌ 检测失败（网络错误等）

**API 端点：**
```
GET /api/monitor/feishu-token
Authorization: Bearer <CRON_SECRET>
```

### 3. 配置 Vercel Cron Job
**文件：** `vercel.json`

```json
{
  "crons": [
    {
      "path": "/api/monitor/feishu-token",
      "schedule": "0 9 * * *"
    }
  ]
}
```

**说明：**
- 每天早上 9:00（UTC）自动执行检查
- 相当于北京时间 17:00

---

## 🔧 配置步骤

### 步骤 1：注册 Resend 邮件服务

Resend 是一个现代化的邮件发送服务，免费计划每月提供 **100 封邮件**（对于监控告警完全够用）。

1. 访问 https://resend.com
2. 注册账号（支持 GitHub 登录）
3. 进入 Dashboard，点击 **API Keys**
4. 创建新的 API Key，复制保存

### 步骤 2：配置本地环境变量

编辑 `.env.local` 文件，添加以下配置：

```bash
# ================== Token 监控告警配置 ==================
# Cron Job 密钥（用于验证定时任务请求）
CRON_SECRET=your-random-secret-token-here  # 生成一个随机字符串

# 接收告警邮件的邮箱
ALERT_EMAIL=your-email@example.com  # 你的邮箱地址

# Resend API Key（免费：每月100封邮件）
RESEND_API_KEY=re_xxxxxxxxxx  # 从 Resend 获取的 API Key
```

**生成 CRON_SECRET：**
```bash
# macOS/Linux
openssl rand -base64 32

# 或者使用在线工具
# https://www.random.org/strings/
```

### 步骤 3：配置 Vercel 环境变量

1. 访问 https://vercel.com/dashboard
2. 选择你的项目 `content-factory`
3. 进入 **Settings > Environment Variables**
4. 添加以下环境变量（所有环境：Production, Preview, Development）：

| 变量名 | 值 | 说明 |
|--------|---|------|
| `CRON_SECRET` | `your-random-secret-token` | Cron Job 验证密钥 |
| `ALERT_EMAIL` | `your-email@example.com` | 接收告警的邮箱 |
| `RESEND_API_KEY` | `re_xxxxxxxxxx` | Resend API Key |

5. **删除以下旧的环境变量**（已弃用）：
   - `KV_REST_API_URL`
   - `KV_REST_API_TOKEN`

### 步骤 4：重新部署到 Vercel

```bash
# 提交代码
git add .
git commit -m "feat: 添加飞书Token过期监控和邮件提醒"
git push

# Vercel 会自动触发部署
```

或者在 Vercel Dashboard 手动重新部署。

### 步骤 5：测试监控功能

部署完成后，手动触发一次检查：

```bash
# 替换为你的实际值
curl -X GET https://content-factory-jade-nine.vercel.app/api/monitor/feishu-token \
  -H "Authorization: Bearer your-cron-secret"
```

**预期响应：**
```json
{
  "status": "valid",
  "message": "Token 有效，剩余 25 天",
  "expires_in": 2160000,
  "daysRemaining": 25,
  "timestamp": "2026-02-02T09:00:00.000Z"
}
```

如果配置正确，你应该会收到邮件（如果 token 即将过期）。

---

## 📧 邮件提醒示例

### 1. Token 即将过期（提前 7 天提醒）

**主题：** ⏰ 飞书 Token 将在 5 天后过期

**内容：**
```
⏰ 飞书 refresh_token 即将过期

你的飞书 FEISHU_REFRESH_TOKEN 将在 5 天后过期。

建议尽快更新：
1. 登录飞书开放平台获取新的 refresh_token
2. 更新本地 .env.local 文件
3. 更新 Vercel 环境变量 FEISHU_REFRESH_TOKEN
4. 重新部署应用

检测时间：2026-02-02 17:00:00
```

### 2. Token 已失效（立即告警）

**主题：** ⚠️ 飞书 Token 已失效 - 需要立即更新

**内容：**
```
⚠️ 飞书 refresh_token 已失效

你的飞书 FEISHU_REFRESH_TOKEN 已经过期，内容工厂的飞书功能将无法使用。

立即处理步骤：
1. 登录飞书开放平台获取新的 refresh_token
2. 更新本地 .env.local 文件
3. 更新 Vercel 环境变量 FEISHU_REFRESH_TOKEN
4. 重新部署应用

检测时间：2026-02-02 17:00:00
```

---

## 🔄 Token 更新流程

当收到邮件提醒后，按照以下步骤更新 Token：

### 步骤 1：获取新的 refresh_token

1. 访问飞书开放平台：https://open.feishu.cn/app
2. 选择你的应用
3. 进入 **权限管理 > 授权管理**
4. 重新授权应用，获取新的 `refresh_token`

### 步骤 2：更新本地环境变量

编辑 `.env.local`，更新以下配置：

```bash
# 飞书 OAuth refresh_token（用于访问个人多维表格）
FEISHU_REFRESH_TOKEN=ur-xxxxxxxxxx  # 替换为新的 token
```

### 步骤 3：更新 Vercel 环境变量

1. 访问 Vercel Dashboard
2. 进入 **Settings > Environment Variables**
3. 编辑 `FEISHU_REFRESH_TOKEN`，更新为新值
4. 点击保存

### 步骤 4：重新部署

```bash
git add .env.local
git commit -m "chore: 更新飞书 refresh_token"
git push
```

---

## 📊 监控频率说明

**当前配置：**
- Vercel Cron Job 每天 UTC 09:00 执行（北京时间 17:00）
- 在 Token 剩余 7 天时开始每天提醒
- Token 过期后立即告警

**为什么选择每天检查？**
- refresh_token 有效期通常为 30 天
- 每天检查可以及时发现问题
- 免费计划足够（每月最多 30 封邮件）

**如何调整频率？**

编辑 `vercel.json`：

```json
{
  "crons": [
    {
      "path": "/api/monitor/feishu-token",
      "schedule": "0 9 * * *"  // 每天 09:00 UTC
    }
  ]
}
```

**常用 Cron 表达式：**
- `0 9 * * *` - 每天 09:00
- `0 9 * * 1` - 每周一 09:00
- `0 9 1 * *` - 每月 1 号 09:00
- `0 */12 * * *` - 每 12 小时

---

## 🚨 故障排查

### 问题 1：没有收到邮件

**可能原因：**
1. Resend API Key 配置错误
2. ALERT_EMAIL 配置错误
3. 邮件被垃圾邮件过滤器拦截

**解决方法：**
1. 检查 Vercel 环境变量配置
2. 查看 Vercel 部署日志，搜索 `[Token Monitor]`
3. 检查垃圾邮件文件夹
4. 在 Resend Dashboard 查看邮件发送记录

### 问题 2：Cron Job 没有执行

**可能原因：**
1. `vercel.json` 配置错误
2. 部署时配置没有生效

**解决方法：**
1. 检查 `vercel.json` 格式
2. 重新部署项目
3. 在 Vercel Dashboard > Settings > Cron Jobs 查看任务状态

### 问题 3：Token 检查失败

**可能原因：**
1. `FEISHU_REFRESH_TOKEN` 已失效
2. 飞书 API 网络问题

**解决方法：**
1. 手动调用 API 查看详细错误信息
2. 检查 Vercel 部署日志
3. 更新 refresh_token

---

## 📝 维护清单

### 每月检查（推荐）
- [ ] 查看 Resend 邮件配额使用情况（免费 100 封/月）
- [ ] 检查 Vercel Cron Job 执行记录
- [ ] 确认告警邮件能够正常接收

### Token 过期前（收到邮件提醒后）
- [ ] 登录飞书开放平台获取新 token
- [ ] 更新本地和 Vercel 环境变量
- [ ] 重新部署并测试

### 可选优化
- [ ] 添加 Slack/企业微信告警通道
- [ ] 记录 Token 更新历史
- [ ] 监控其他 API Token（如 Gemini、MyAIBot）

---

## 🔗 相关链接

- **Resend 文档：** https://resend.com/docs
- **Vercel Cron Jobs 文档：** https://vercel.com/docs/cron-jobs
- **飞书开放平台：** https://open.feishu.cn
- **Cron 表达式生成器：** https://crontab.guru

---

## 💡 后续优化建议

1. **多渠道告警：**
   - 除了邮件，还可以集成 Slack、钉钉、企业微信等
   - 添加短信告警（使用阿里云 SMS）

2. **Token 自动续期：**
   - 理论上可以在检测到即将过期时自动刷新并更新环境变量
   - 但 Vercel 环境变量更新需要 API，实现较复杂

3. **监控面板：**
   - 创建一个简单的监控页面，显示所有 API Token 的状态
   - 支持手动触发检查

4. **历史记录：**
   - 记录每次检查的结果到数据库（如 Vercel Postgres）
   - 生成 Token 健康度报告

---

**文档创建时间：** 2026-02-02
**维护人：** Claude Code
**下次更新：** 根据实际使用情况调整
