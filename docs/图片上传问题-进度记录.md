# 小红书笔记采集 - 图片上传问题进度记录

**日期**: 2025-01-20
**状态**: 文本内容保存成功，图片上传功能待解决

---

## 当前进展

### ✅ 已完成功能
- [x] 小红书笔记解析（标题、正文、话题标签、图片URL）
- [x] 飞书应用和机器人配置
- [x] 群组创建和权限配置
- [x] Vercel KV 存储实现（自动刷新refresh_token）
- [x] 文本字段保存到飞书表格
  - 标题
  - 正文
  - 话题标签
  - 笔记链接

### ❌ 待解决问题
- [ ] 图片上传到飞书获取file_token失败
- [ ] 附件字段无法写入（因为缺少file_token）

---

## 问题详情

### 核心问题
飞书文件上传API `/drive/v1/files/upload_all` 持续返回：
```json
{
  "code": 1061002,
  "msg": "params error."
}
```

### 已尝试的方案
1. ❌ 使用 user_access_token + FormData
2. ❌ 使用 app_access_token + FormData
3. ❌ 添加 parent_node 参数
4. ❌ 移除 parent_node 参数
5. ❌ 修改 file_type 为 'stream'
6. ❌ 添加 size 参数
7. ❌ 简化 FormData 字段
8. ❌ 尝试传递 URL 对象到附件字段 → AttachFieldConvFail

### 当前上传代码（失败版本）
位置：`/lib/feishuAuth.ts:176-222`

```typescript
export async function uploadFileToFeishu(
  fileBuffer: Buffer,
  fileName: string,
  fileType: string = 'image',
  parentType: string = 'bitable',
  parentNode?: string
): Promise<string> {
  const userAccessToken = await getUserAccessToken()

  const formData = new FormData()
  const uint8Array = new Uint8Array(fileBuffer)
  const blob = new Blob([uint8Array], { type: 'image/jpeg' })
  formData.append('file_name', fileName)
  formData.append('file_type', 'stream')
  formData.append('file', blob, fileName)
  formData.append('size', String(fileBuffer.length))

  const response = await fetch(`${FEISHU_API_URL}/drive/v1/files/upload_all`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${userAccessToken}`
    },
    body: formData
  })

  const data = await response.json()

  if (data.code !== 0) {
    console.error('[飞书文件上传] 上传失败:', data)
    throw new Error(`文件上传失败: ${data.msg}`)
  }

  return data.data.file_token
}
```

---

## 解决方案

### 方案A：继续调试文件上传代码（难度高）

**线索来源：coze 工作流成功案例**

coze 能够成功实现的流程：
1. 使用小红书插件获取图片URL
2. 下载图片
3. **上传到飞书成功** ← 我们卡在这一步
4. 获取 file_token
5. 写入附件字段 `[{ file_token: "xxx" }]`

**下一步调试方向：**

1. **查看飞书官方SDK实现**
   - Node.js SDK: https://github.com/larksuite/node-sdk
   - Go SDK: https://github.com/chyroc/lark
   - 对比参数格式和请求方式

2. **可能的问题点：**
   - FormData 的构造方式
   - Blob 的 MIME 类型
   - 文件名格式
   - Content-Type header
   - file_type 参数的正确值

3. **深入调试：**
   ```typescript
   // 添加详细日志
   console.log('FormData entries:', Array.from(formData.entries()))
   console.log('Blob size:', blob.size)
   console.log('Blob type:', blob.type)
   ```

4. **参考成功案例：**
   - 寻找其他开发者的飞书文件上传实现
   - 查看 GitHub issues 中是否有类似问题

**优点：**
- ✅ 完全符合原始需求（使用附件字段）
- ✅ 图片直接存储在飞书云盘
- ✅ 不依赖外部图片链接

**缺点：**
- ❌ 调试难度高，时间成本大
- ❌ 可能需要联系飞书技术支持
- ❌ 不确定能否解决

---

### 方案B：改用URL字段（推荐，简单快捷）

**实施方案：**

#### 1. 修改表格字段类型
- 将"封面"、"图片2"、"图片3"字段类型从**附件**改为**URL**
- 或者新建"图片链接1"、"图片链接2"、"图片链接3"字段（类型：URL）

#### 2. 修改代码
位置：`/app/api/xiaohongshu/quick-save/route.ts`

```typescript
// 当前代码（需要修改）
async function saveToFeishu(
  appToken: string,
  tableId: string,
  title: string,
  content: string,
  tags: string,
  imageUrls: string[],  // 直接使用图片URL
  url: string
) {
  const fields: any = {
    '标题': title,
    '正文': content,
    '话题标签': tags,
    '笔记链接': url
  }

  // 新方案：直接传递URL字符串到URL字段
  if (imageUrls.length > 0) {
    fields['图片链接1'] = imageUrls[0]  // URL字段，直接传字符串
  }

  if (imageUrls.length > 1) {
    fields['图片链接2'] = imageUrls[1]
  }

  if (imageUrls.length > 2) {
    fields['图片链接3'] = imageUrls[2]
  }

  // 保存到飞书...
}
```

#### 3. 完整修改清单
- [ ] 删除 `uploadFileToFeishu` 函数（或注释掉）
- [ ] 删除 `processImages` 函数
- [ ] 删除 `downloadImage` 函数
- [ ] 修改 `saveToFeishu` 函数，直接传递URL
- [ ] 在飞书表格中创建URL类型字段

**优点：**
- ✅ 实现简单，立即可用
- ✅ 不需要下载和上传文件
- ✅ 飞书URL字段支持图片预览
- ✅ 节省飞书云盘空间
- ✅ 图片加载更快（直接从小红书CDN）

**缺点：**
- ❌ 依赖小红书图片链接的有效性
- ❌ 如果小红书删除图片，预览会失效
- ❌ 不是存储在飞书云盘中

**coze 工作流验证：**
你的 coze 代码证明了这个方案可行：
```javascript
fields.图片链接 = item.imageUrl;  // 直接传递URL字符串
```

---

## 当前代码状态

### 文件清单
```
/lib/feishuAuth.ts              - 飞书认证和KV存储
/app/api/xiaohongshu/quick-save/route.ts  - 主要API
/app/api/test/read-record/route.ts  - 测试API
/package.json                   - 依赖包含 @vercel/kv
```

### 环境变量
```bash
# 飞书应用
FEISHU_APP_ID=cli_a9bac6be07789cc4
FEISHU_APP_SECRET=***
FEISHU_REFRESH_TOKEN=***  # 初始值，后续由KV自动更新

# Vercel KV (Upstash)
STORAGE_REST_API_URL=***
STORAGE_REST_API_TOKEN=***

# 飞书表格
FEISHU_DEFAULT_APP_TOKEN=NNd8bJYazaBwHAsZ2z2cqsvmnqf
FEISHU_DEFAULT_TABLE_ID=tblDIyXg0KxEueyB
```

### Git 提交历史
- `f6234fa` - refactor: 简化图片处理 - 直接使用URL而非文件上传
- `9227d78` - 试验：附件字段传递url/tmp_url对象
- `3047bca` - 临时方案：图片URL保存到备注字段而非附件字段

### 当前分支
- main (已推送到远程)

---

## 下一步行动建议

### 短期方案（明天执行）
**推荐：方案B - 改用URL字段**
1. 在飞书表格中创建3个URL类型字段
2. 修改代码直接传递图片URL
3. 测试验证图片预览功能
4. 预计耗时：30分钟

### 长期方案（可选）
**方案A - 继续调试文件上传**
1. 深入研究飞书SDK源码
2. 对比成功案例的实现
3. 逐步调试找出params error原因
4. 预计耗时：未知（可能需要几天）

---

## 技术要点记录

### 飞书附件字段格式
读取记录时的格式：
```json
"封面": [{
  "file_token": "GBzxbmUohoac1qxarEVcNMP6nbb",
  "name": "image_1765136205991_0.jpg",
  "size": 373379,
  "tmp_url": "...",
  "type": "image/jpeg",
  "url": "..."
}]
```

写入记录时**必须**使用：
```json
"封面": [{ "file_token": "xxx" }]
```

直接传URL会报错：
```json
// ❌ 错误
"封面": "https://..."
"封面": [{ "url": "https://..." }]
"封面": [{ "tmp_url": "https://..." }]

// ✅ 正确（但需要先上传文件获取file_token）
"封面": [{ "file_token": "xxx" }]
```

### Vercel KV 配置
```typescript
import { createClient } from '@vercel/kv'

const kv = createClient({
  url: process.env.STORAGE_REST_API_URL || '',
  token: process.env.STORAGE_REST_API_TOKEN || ''
})

// 存储refresh_token
await kv.set('feishu:refresh_token', newRefreshToken)

// 读取refresh_token
const token = await kv.get<string>('feishu:refresh_token')
```

### 小红书图片URL格式
```
http://sns-webpic-qc.xhscdn.com/202501201805/.../...!nd_dft_wlteh_webp_3
```

- 直接可访问
- 支持预览
- 来自小红书CDN

---

## 参考资源

### 官方文档
- [飞书开放平台 - 多维表格](https://open.feishu.cn/document/server-docs/docs/bitable-v1/bitable-overview)
- [飞书 - 附件字段](https://open.feishu.cn/document/server-docs/docs/bitable-v1/app-table-field/attachment)
- [飞书 - 上传文件](https://open.feishu.cn/document/ukTMukTMukTM/uUjM5YjL1ITO24SNykjN)

### GitHub项目
- [chyroc/lark](https://github.com/chyroc/lark) - Feishu/Lark Go SDK
- [larksuite/node-sdk](https://github.com/larksuite/node-sdk) - 官方 Node.js SDK

### 相关文章
- [扣子Coze智能体实战：批量抓取小红书笔记](https://www.cnblogs.com/tangshiye/p/19050067)
- [Coze实战教程：提取小红书博主笔记](https://www.cnblogs.com/tommywow/p/18959080)

---

## 联系信息

如需技术支持：
- 飞书开放平台工单系统
- GitHub Issues: https://github.com/baidu0717/content-factory/issues

---

*最后更新：2025-01-20 18:30*
