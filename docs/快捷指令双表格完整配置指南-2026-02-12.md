# 快捷指令双表格完整配置指南

**更新日期**: 2026-02-12
**状态**: ✅ 已完成并测试通过

---

## 📋 目录

1. [功能概述](#功能概述)
2. [问题记录与修复](#问题记录与修复)
3. [快捷指令配置](#快捷指令配置)
4. [API修复详情](#api修复详情)
5. [测试验证](#测试验证)
6. [故障排查](#故障排查)

---

## 功能概述

### 实现目标

一个 iOS 快捷指令，可以：
- 从剪贴板读取小红书链接
- 选择保存到两个不同的飞书表格（法意瑞/其他国家）
- 自动提取笔记内容、图片、互动数据
- 保存到对应的飞书多维表格

### 两个飞书表格

**表格1：法意瑞（个人表格）**
- APP_TOKEN: `NNd8bJYazaBwHAsZ2z2cqsvmnqf`
- TABLE_ID: `tblu1m2GPcFRNSPE`
- URL: https://ai.feishu.cn/base/NNd8bJYazaBwHAsZ2z2cqsvmnqf?table=tblu1m2GPcFRNSPE

**表格2：其他国家（工作表格）**
- APP_TOKEN: `McFGbxqi6aSd0HsBCSlc5kI7nwc`
- TABLE_ID: `tbltp6uHpdKRF68a`
- URL: https://my.feishu.cn/base/McFGbxqi6aSd0HsBCSlc5kI7nwc?table=tbltp6uHpdKRF68a

---

## 问题记录与修复

### 问题1: 快捷指令报错"请提供小红书链接" ❌

**现象**:
- 快捷指令运行后立即报错
- 错误信息："❌ 请提供小红书链接"

**原因**:
- 快捷指令的 JSON 请求体配置方式不对
- iOS 快捷指令的 JSON 模式下，直接插入变量可能失败

**解决方案**:
1. 使用「文本」操作构建 JSON
2. 在「获取 URL 内容」中，请求体选择「文件」模式
3. 选择「文本」变量作为请求体

**关键步骤**:
```
1. 创建「文本」操作，内容为：
   {
     "url": "[URL变量]",
     "appToken": "[appToken变量]",
     "tableId": "[tableId变量]",
     "async": false
   }

2. 在「获取 URL 内容」中：
   - 请求体: 从「JSON」改为「文件」
   - 选择「文本」变量
```

---

### 问题2: 其他国家表格报错 "Forbidden" ❌

**现象**:
- 选择"法意瑞"时成功
- 选择"其他国家"时报错："保存失败：Forbidden"

**原因**:
- 其他国家表格缺少飞书应用的协作权限
- 法意瑞表格有以下应用：
  - 内容工厂-数据同步（可管理）
  - 小红书笔记采集（可编辑）
  - 多维表格助手（可编辑）
- 其他国家表格缺少这些应用

**解决方案**:
1. 打开其他国家表格
2. 点击「管理协作者」
3. 添加以下应用：
   - **内容工厂-数据同步** - 权限：可管理（最重要！）
   - 小红书笔记采集 - 权限：可编辑
   - 多维表格助手 - 权限：可编辑

**验证**:
- 两个表格的协作者列表应该一致
- 都包含上述3个应用

---

### 问题3: 图片缺失（第二张图片丢失）❌

**现象**:
- 法意瑞表格：缺少封面图片
- 其他国家表格：缺少第二张图片
- 其他图片正常

**Vercel 日志分析**:
```
[飞书Auth] 刷新user_access_token失败: {
  code: 20038,
  message: 'The refresh token passed is not found.'
}
[图片处理] ❌ 第 2 张图片处理失败: Error: 刷新token失败
```

**原因**:
- 多张图片并发上传时，同时触发 Token 刷新
- 第一个请求刷新成功，获得新的 refresh_token
- 第二个请求使用旧的 refresh_token，导致失败（旧 token 已作废）
- 飞书的 refresh_token 特点：**刷新一次后，旧的立即失效**

**解决方案**:
在 `lib/feishuAuth.ts` 中添加 Token 刷新锁：

```typescript
// Token 刷新锁（防止并发刷新冲突）
let userTokenRefreshPromise: Promise<string> | null = null

export async function getUserAccessToken(): Promise<string> {
  // 检查缓存
  if (cachedUserAccessToken && userTokenExpireTime > now + 5 * 60 * 1000) {
    return cachedUserAccessToken
  }

  // 如果已经有正在进行的刷新操作，等待它完成
  if (userTokenRefreshPromise) {
    console.log('[飞书Auth] 等待正在进行的token刷新...')
    return await userTokenRefreshPromise
  }

  // 创建刷新Promise并加锁
  userTokenRefreshPromise = (async () => {
    try {
      // ... 刷新逻辑 ...
      return access_token
    } finally {
      // 无论成功或失败，都清除刷新锁
      userTokenRefreshPromise = null
    }
  })()

  return await userTokenRefreshPromise
}
```

**效果**:
- 修复前：图片1成功，图片2失败 ❌
- 修复后：所有图片都成功 ✅

**相关提交**:
- Commit: `19a00ca` - fix: 修复并发图片上传时Token刷新冲突导致图片丢失

---

## 快捷指令配置

### 完整流程

```
1. 获取剪贴板
2. 从 剪贴板 获取 URL
3. 从菜单中选择
   - 提示: "选择保存到哪个表格"
   - 选项1: 法意瑞
   - 选项2: 其他国家
4. 如果 = 法意瑞
   - 设定变量 appToken = NNd8bJYazaBwHAsZ2z2cqsvmnqf
   - 设定变量 tableId = tblu1m2GPcFRNSPE
5. 否则
   - 设定变量 appToken = McFGbxqi6aSd0HsBCSlc5kI7nwc
   - 设定变量 tableId = tbltp6uHpdKRF68a
6. 结束 If
7. 文本（构建 JSON）
   {
     "url": "[URL]",
     "appToken": "[appToken]",
     "tableId": "[tableId]",
     "async": false
   }
8. 获取 URL 内容
   - URL: https://content-factory-jade-nine.vercel.app/api/xiaohongshu/quick-save
   - 方法: POST
   - 头部: Content-Type: application/json
   - 请求体: 文件（选择上面的「文本」变量）
9. 从 URL的内容 中获取 message 的 值
10. 显示通知（显示 message）
```

### 关键配置点

**步骤4-5：设定变量的值**

在「设定变量」操作中输入固定文本值的方法：
1. 点击值输入框
2. 选择「输入快捷指令的信息」
3. 在弹出的输入框中粘贴值

**步骤7：文本操作（构建 JSON）**

1. 先输入 JSON 框架（纯文本）
2. 在引号之间插入变量：
   - 点击 `"url": ""` 的两个引号之间
   - 选择「变量」→「URL」
   - 重复操作，插入 appToken 和 tableId

**步骤8：获取 URL 内容**

**重要**：请求体必须选择「文件」模式！
- 点击「请求体: JSON」
- 改为「文件」
- 选择「文本」变量

---

## API修复详情

### 修复1: 并发 Token 刷新冲突

**文件**: `lib/feishuAuth.ts`

**修改内容**:
1. 添加刷新锁变量
2. 修改 `getUserAccessToken` 函数
3. 增加错误码判断（20038）

**关键代码**:
```typescript
// 添加刷新锁
let userTokenRefreshPromise: Promise<string> | null = null

// 在刷新前检查
if (userTokenRefreshPromise) {
  console.log('[飞书Auth] 等待正在进行的token刷新...')
  return await userTokenRefreshPromise
}

// 包装刷新逻辑
userTokenRefreshPromise = (async () => {
  try {
    // ... 刷新逻辑 ...
  } finally {
    userTokenRefreshPromise = null
  }
})()
```

**测试结果**:
- ✅ 多张图片并发上传时，不再出现 Token 冲突
- ✅ 所有图片都能成功上传
- ✅ 日志显示：`[飞书Auth] 等待正在进行的token刷新...`

---

## 测试验证

### 测试用例1: 2张图片的笔记

**测试链接**: `http://xhslink.com/o/6UB4sOBPVs6`

**法意瑞表格**:
- ✅ 封面图片：正常
- ✅ 图片2：正常
- ✅ 作者、标题、正文：正常
- ✅ 互动数据：正常

**其他国家表格**:
- ✅ 封面图片：正常
- ✅ 图片2：正常（修复前缺失）
- ✅ 所有数据：正常

---

### 测试用例2: 9张图片的笔记

**测试链接**: `http://xhslink.com/o/1tgpiJnGEBy`

**法意瑞表格**:
- ✅ 封面（图1）：正常
- ✅ 图片2（图2）：正常
- ✅ 后续图片（图3-9）：全部正常
- ✅ 共9张图片全部保存成功

**日志验证**:
```
[图片处理] 共成功处理 9/9 张图片
[图片处理] 结果数组: 图1:✓, 图2:✓, 图3:✓, 图4:✓, 图5:✓, 图6:✓, 图7:✓, 图8:✓, 图9:✓
```

---

## 故障排查

### 常见问题

#### Q1: 快捷指令报错"请提供小红书链接"

**检查清单**:
- [ ] 剪贴板中有小红书链接
- [ ] 「从 剪贴板 获取 URL」操作存在
- [ ] 「文本」操作中的 JSON 格式正确
- [ ] 「文本」中的变量是蓝色/橙色标签（不是纯文本）
- [ ] 「获取 URL 内容」的请求体选择了「文件」模式
- [ ] 请求体引用了「文本」变量

#### Q2: 报错 "Forbidden"

**检查清单**:
- [ ] 打开对应的飞书表格，确认能访问
- [ ] 点击「管理协作者」
- [ ] 检查是否有以下应用：
  - [ ] 内容工厂-数据同步（权限：可管理）
  - [ ] 小红书笔记采集（权限：可编辑）
  - [ ] 多维表格助手（权限：可编辑）
- [ ] 如果缺少，点击「添加协作者」搜索并添加

#### Q3: 图片丢失

**检查清单**:
- [ ] 查看 Vercel 日志（https://vercel.com → 项目 → Logs）
- [ ] 搜索 `[图片处理]` 查看处理过程
- [ ] 搜索 `❌` 或 `失败` 查看错误
- [ ] 检查是否有 Token 刷新失败的错误
- [ ] 确认最新代码已部署（包含并发锁修复）
- [ ] 重新运行快捷指令测试

#### Q4: 飞书 Token 过期

**解决方法**:
1. 访问 https://content-factory-jade-nine.vercel.app/feishu-auth
2. 重新授权
3. 系统会自动更新 Vercel 环境变量
4. 等待1-2分钟后重试

---

## 技术要点总结

### iOS 快捷指令

1. **JSON 请求体的正确方式**:
   - 用「文本」操作构建 JSON
   - 在「获取 URL 内容」中使用「文件」模式
   - 不要直接在 JSON 键值对界面插入复杂变量

2. **变量传递**:
   - If/Else 中设置的变量，在后续步骤中可用
   - 变量显示为彩色标签，不是纯文本
   - 使用「输入快捷指令的信息」来输入固定文本值

3. **调试技巧**:
   - 添加「显示通知」查看变量值
   - 用固定值替换变量来排查问题
   - 简化版本（删除菜单）来测试基础功能

### 飞书 API

1. **Token 刷新机制**:
   - refresh_token 只能用一次，刷新后立即作废
   - 并发请求需要加锁，避免冲突
   - user_access_token 有效期 2 小时
   - app_access_token 有效期约 43 分钟

2. **多维表格权限**:
   - 表格需要授权给应用（协作者）
   - 即使是表格所有者，API 调用也需要应用权限
   - 不同表格需要分别授权

3. **图片上传**:
   - 使用 user_access_token（不是 app_access_token）
   - 并发数控制在4个/批次
   - 每张图片重试5次
   - HEIF 格式自动转 JPEG

---

## 部署信息

**Git 仓库**: https://github.com/baidu0717/content-factory
**Vercel 项目**: content-factory-jade-nine
**生产环境**: https://content-factory-jade-nine.vercel.app

**相关提交**:
- `19a00ca` - fix: 修复并发图片上传时Token刷新冲突导致图片丢失
- `5378c65` - docs: 添加图片处理优化记录文档
- `e06092b` - feat: 极致了API增加重试机制，提高容错性

---

## 维护建议

1. **定期检查 Token**:
   - 每月访问一次 `/feishu-auth` 刷新 Token
   - 确保 FEISHU_REFRESH_TOKEN 环境变量有效

2. **监控 Vercel 日志**:
   - 定期查看错误日志
   - 关注图片处理失败的情况
   - 检查 API 调用是否正常

3. **表格权限**:
   - 新建表格时，记得添加应用协作者
   - 确保所有表格的权限配置一致

4. **快捷指令备份**:
   - 导出快捷指令的 iCloud 链接
   - 记录所有表格的 appToken 和 tableId
   - 保存配置文档

---

**文档维护**: baidu
**最后更新**: 2026-02-12 06:30
**状态**: ✅ 所有功能正常，已验证
