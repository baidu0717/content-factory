# 代码进度记录 - 2026-02-18

**状态**: ✅ 四表格 + 备注 + 图片后台上传 全部正常

---

## 本阶段完成内容

### 1. 删除定时监控功能

原有的「定时监控/选题分析 Cron」功能已完整删除，共清理 7 个文件：
- `app/api/cron/daily-analysis/route.ts`
- `app/api/monitored-keywords/route.ts`
- `app/api/scheduled-reports/route.ts`
- `app/reports/[id]/page.tsx`
- `scripts/cron-scheduler.ts`
- `lib/scheduler.ts`
- `MONITORING_GUIDE.md`

### 2. 四张飞书表格支持

快捷指令现在支持选择 4 张飞书表格：

| 表格名称 | APP_TOKEN | TABLE_ID |
|---------|-----------|----------|
| 法意瑞 | `NNd8bJYazaBwHAsZ2z2cqsvmnqf` | `tblu1m2GPcFRNSPE` |
| 西班牙 | `NNd8bJYazaBwHAsZ2z2cqsvmnqf` | `tbltUxC0qElUbibT` |
| 意大利 | `NNd8bJYazaBwHAsZ2z2cqsvmnqf` | `tbl5WFtr4k8sQVJP` |
| 聚光投放 | `McFGbxqi6aSd0HsBCSlc5kI7nwc` | `tbltp6uHpdKRF68a` |

> 法意瑞、西班牙、意大利 三张表格在同一个飞书文档内，共享 APP_TOKEN，无需单独配置应用权限。

### 3. 备注字段

- API 新增 `remark` 参数（可选）
- 快捷指令增加「文本输入」步骤，用户可输入备注
- 备注自动写入飞书表格的「备注」列

### 4. 混合模式（核心架构升级）

**背景**：原来的两种模式都有问题：
- `async: false`（同步）：图片处理超时，iOS 快捷指令报错
- `async: true`（纯后台）：Vercel 函数在返回响应后立即终止，图片从未上传

**新方案 - 混合模式**（`async: true` 触发）：
```
1. 同步解析笔记内容       → 失败立即返回错误
2. 同步写入文字到飞书     → 失败立即返回错误（Forbidden 等）
3. 返回成功响应给手机      → 快捷指令立即显示结果
4. after() 后台上传图片   → 不阻塞、不超时
5. 图片上传完成后更新记录  → 调用飞书 PUT API 补全图片
```

**关键技术**：
- 使用 `next/server` 的 `after()` API 保证后台任务在响应发出后继续执行
- `saveToFeishu` 返回 `record_id`，供后续图片更新使用
- 新增 `processImagesAndUpdate()` 函数：上传图片 → PUT 更新已有记录

---

## 修复的 Bug

### Bug 1：Vercel 提前终止后台任务
- **现象**：文字保存成功，图片从不上传
- **原因**：`Promise.catch()` 启动的后台任务在 return 响应后被 Vercel 杀死
- **修复**：改用 `after()` API，Vercel 保证回调在响应后继续执行
- **提交**：`4a11c2f`

### Bug 2：record_id 取值路径错误
- **现象**：`after()` 修复后图片依然不上传
- **原因**：`data.data?.record_id` 应为 `data.data?.record?.record_id`
  - 飞书创建记录 API 响应：`{ data: { record: { record_id: "..." } } }`
  - 多了一层 `record`，导致 `recordId` 始终为 `undefined`
  - `if (images.length > 0 && recordId)` 条件永远为 false，`after()` 从未注册
- **修复**：修正取值路径
- **提交**：`4ccd16e`

---

## 快捷指令配置

### JSON 请求体结构

```json
{
  "url": "[小红书链接]",
  "appToken": "[表格的 APP_TOKEN]",
  "tableId": "[表格的 TABLE_ID]",
  "async": true,
  "remark": "[备注内容，可留空]"
}
```

### 快捷指令步骤（参考）

```
1. 获取剪贴板 URL
2. 文本输入（输入备注，可跳过）
3. 从菜单中选择表格
   - 法意瑞 → appToken=NNd8..., tableId=tblu1...
   - 西班牙 → appToken=NNd8..., tableId=tbltU...
   - 意大利 → appToken=NNd8..., tableId=tbl5W...
   - 聚光投放 → appToken=McFG..., tableId=tbltp...
4. 文本操作（构建 JSON，插入变量）
5. 获取 URL 内容（POST，请求体选「文件」模式）
6. 从响应中取 message 字段
7. 显示通知
```

> **重要**：「获取 URL 内容」的请求体必须选「文件」模式，不能选「JSON」模式。

---

## 如需新增表格

1. 在飞书多维表格中新建一张表（建议在同一个文档内，继承权限）
2. 确保表格有以下字段：
   `笔记链接`、`作者昵称`、`封面`、`图片2`、`后续图片`、`标题`、`正文`、`话题标签`、`浏览数`、`点赞数`、`收藏数`、`评论数`、`发布时间`、`备注`
3. 获取新表格的 `TABLE_ID`（URL 中 `?table=` 后的部分）
4. 在 iOS 快捷指令中添加新的菜单选项，配置对应的 `appToken` 和 `tableId`
5. API 代码无需修改（`appToken` 和 `tableId` 由快捷指令动态传入）

---

## 相关提交

| Commit | 说明 |
|--------|------|
| `8a937e3` | chore: 删除定时监控功能 |
| `d5d6338` | feat: 支持3张飞书表格和备注字段功能 |
| `e3ac34e` | feat: 实现混合模式 - 同步写入文字 + 后台上传图片 |
| `4a11c2f` | fix: 使用 after() 修复后台图片上传被 Vercel 提前终止 |
| `4ccd16e` | fix: 修正飞书 API 响应路径，record_id 取值错误 |

---

**文档维护**: baidu
**最后更新**: 2026-02-18
**状态**: ✅ 全部功能正常，已验证
