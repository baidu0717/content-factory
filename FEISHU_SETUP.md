# 飞书多维表格API配置指南

## 📋 前置准备

### 1. 创建飞书自建应用

1. **访问飞书开放平台**
   - 打开：https://open.feishu.cn/
   - 使用飞书账号登录

2. **创建企业自建应用**
   - 点击「开发者后台」
   - 点击「创建企业自建应用」
   - 填写应用名称：`内容工厂小红书采集`
   - 上传应用图标（可选）
   - 点击「创建」

3. **获取 App ID 和 App Secret**
   - 进入应用详情页
   - 在「凭证与基础信息」中找到：
     - `App ID`：cli_xxxxxxxxx
     - `App Secret`：点击「查看」获取

4. **开通权限**
   - 进入「权限管理」
   - 搜索并开通以下权限：
     - ✅ `bitable:app`（获取多维表格信息）
     - ✅ `bitable:app:readonly`（查看多维表格）
     - ✅ `bitable:app:update`（编辑多维表格）
   - 点击「发布版本」使权限生效

---

## 📊 创建飞书多维表格

### 1. 创建多维表格

1. **打开飞书客户端或网页版**
2. **新建多维表格**
   - 点击「新建」→ 选择「多维表格」
   - 命名：`小红书笔记采集`

### 2. 设置表格字段结构

在多维表格中创建以下字段（按顺序）：

| 字段名 | 字段类型 | 说明 |
|--------|---------|------|
| 标题 | 单行文本 | 笔记标题 |
| 作者 | 单行文本 | 作者昵称 |
| 发布时间 | 单行文本 | 笔记发布时间 |
| 图片1 | URL | 第一张图片URL（自动显示预览） |
| 图片2 | URL | 第二张图片URL（自动显示预览） |
| 图片3 | URL | 第三张图片URL（自动显示预览） |
| 正文内容 | 多行文本 | 笔记正文 |
| 话题标签 | 单行文本 | 话题和标签 |
| 笔记链接 | URL | 小红书笔记链接 |
| 采集时间 | 单行文本 | 导入到表格的时间 |

**⭐ 重要提示：**
- **图片字段选择「URL」类型**，飞书会自动显示图片预览，且不占用云盘空间
- 字段名必须与上表完全一致（包括中文标点符号）
- 如果需要更好的展示效果，可以创建「画廊视图」以图片为主展示

### 3. 获取 App Token 和 Table ID

#### 方法一：从URL获取（推荐）

1. 打开创建好的多维表格
2. 查看浏览器地址栏URL：
   ```
   https://xxx.feishu.cn/base/xxxxxxxxxxxxxxxxxxxxxx?table=tblxxxxxx&view=vewxxxxxx
                            ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑        ↑↑↑↑↑↑↑↑
                            这是 app_token                  这是 table_id
   ```

   或者可能是这样的格式：
   ```
   https://ai.feishu.cn/wiki/NkalwhXcuiVzc8kDcqUctbvtnef
                             ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑
                             这是 app_token（完整路径里的标识符）
   ```

3. **获取 app_token：**
   - 如果是 `/base/` 路径：复制 `base/` 后面的那一段长字符串
   - 如果是 `/wiki/` 路径：复制 `wiki/` 后面的那一段字符串（如 `NkalwhXcuiVzc8kDcqUctbvtnef`）

4. **获取 table_id：**
   - 方法1：URL 参数中 `?table=` 后面的值（如 `tblxxxxxx`）
   - 方法2：如果URL中没有，点击多维表格底部的某个数据表标签，URL会显示 table 参数

#### 方法二：使用API查询

如果方法一无法获取 table_id，可以：
1. 先配置好 `FEISHU_APP_ID`、`FEISHU_APP_SECRET` 和 `FEISHU_APP_TOKEN`
2. 访问飞书开放平台的 API 调试工具
3. 调用「获取多维表格数据表列表」API 查看所有 table_id

---

## ⚙️ 配置环境变量

### 1. 编辑 `.env.local` 文件

在项目根目录的 `.env.local` 文件中添加：

```bash
# ================== 飞书API配置 ==================

# 飞书应用凭证
FEISHU_APP_ID=cli_xxxxxxxxxxxxxxxxx       # 替换为你的 App ID
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxx    # 替换为你的 App Secret

# 飞书多维表格配置
FEISHU_APP_TOKEN=NkalwhXcuiVzc8kDcqUctbvtnef  # 替换为你的多维表格 app_token
FEISHU_TABLE_ID=tblxxxxxx                      # 替换为你的数据表 table_id

# 飞书API端点（通常不需要修改）
FEISHU_API_URL=https://open.feishu.cn/open-apis
```

### 2. 重启开发服务器

配置完成后重启 Next.js 开发服务器：

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
npm run dev
```

---

## ✅ 验证配置

配置完成后，你可以在「小红书采集」页面测试：

1. 输入一个小红书链接
2. 点击「提取并保存到飞书」
3. 检查飞书多维表格是否成功添加了新记录

---

## 🔧 故障排查

### 问题1：提示「未配置飞书API」

**解决**：检查 `.env.local` 文件中的配置是否正确，并重启服务器。

### 问题2：提示「权限不足」

**解决**：
1. 检查应用是否已开通 `bitable:app`、`bitable:app:readonly`、`bitable:app:update` 权限
2. 确认应用已发布版本
3. 在多维表格右上角「...」→「高级设置」→「应用管理」中添加你的应用

### 问题3：提示「多维表格不存在」

**解决**：
1. 检查 `FEISHU_APP_TOKEN` 是否正确（从URL中复制）
2. 确认你有访问该多维表格的权限

### 问题4：提示「数据表不存在」

**解决**：
1. 检查 `FEISHU_TABLE_ID` 是否正确
2. 在多维表格底部确认数据表是否存在
3. 尝试点击数据表标签，从URL中重新获取 table_id

### 问题5：字段名不匹配

**错误示例**：`追加记录失败: field [标题] not found`

**解决**：
1. 检查多维表格中的字段名是否与文档中的完全一致
2. 注意中文标点符号（必须是中文）
3. 不要有多余的空格

### 问题6：图片无法显示预览

**解决**：
1. 确认字段类型设置为「URL」（不是「文本」）
2. 小红书图片URL可能有防盗链，这是正常现象
3. 可以在多维表格中手动点击URL查看图片

---

## 🎨 推荐配置

### 创建多视图提升体验

**画廊视图（图片展示）：**
1. 点击表格顶部「+」添加视图
2. 选择「画廊视图」
3. 封面图选择「图片1」
4. 标题选择「标题」
5. 完美！现在可以像浏览 Pinterest 一样查看笔记

**看板视图（工作流管理）：**
1. 先添加一个「单选」字段，命名为「状态」
2. 选项：`待处理` / `已复刻` / `已发布`
3. 创建看板视图，按「状态」分组
4. 拖拽卡片即可更改状态

---

## 📞 获取帮助

如果遇到问题，请检查：
1. 飞书开放平台文档：https://open.feishu.cn/document/server-docs/docs/bitable-v1/bitable-overview
2. 应用权限是否正确开通
3. app_token 和 table_id 是否正确复制
4. 字段名是否完全一致

---

## 🎯 下一步

配置完成后，就可以开始使用「小红书采集」功能了！

前往：`/xiaohongshu-extract` 页面开始采集笔记。

### 使用建议

1. **采集笔记**：在采集页面输入小红书链接，一键提取并保存
2. **整理分类**：在飞书多维表格中使用筛选、分组功能整理笔记
3. **创建视图**：根据需求创建不同视图（画廊、看板、表格）
4. **一键复刻**：在采集页面点击「前往复刻」跳转到复刻页面
5. **知识积累**：持续采集，建立你的内容素材库
